<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perfil Territorial: {{ nombre_parroquia }}</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Ubuntu', sans-serif; background-color: #0d1117; color: #c9d1d9; margin: 2em; }
    .main-container { width: 95%; max-width: 1800px; margin: 0 auto; }
    h1 { color: #58a6ff; text-align: center; font-weight: 300; margin-bottom: 20px; }
    .navigation { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; flex-wrap: wrap; }
    .navigation a { color: #8b949e; text-decoration: none; padding: 8px 15px; border-radius: 6px; border: 1px solid #30363d; transition: all 0.2s ease-in-out; }
    .navigation a.active, .navigation a:hover { color: #c9d1d9; background-color: #161b22; border-color: #58a6ff; }
    .chart-container { background-color: #161b22; border: 2px solid #30363d; border-radius: 8px; padding: 20px; margin-bottom: 30px; }
    #map { width: 100%; height: 600px; border-radius: 8px; }
    .kpi-section { display: flex; gap: 40px; justify-content: space-around; margin: 30px 0; }
    .kpi-card { text-align: center; }
    .kpi-value { font-size: 2.5em; font-weight: 700; color: #c9d1d9; }
    .kpi-label { font-size: 1em; color: #8b949e; }
    footer { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 50px; padding-top: 20px; border-top: 1px solid #30363d; color: #8b949e;}
    footer img { max-height: 40px; opacity: 0.8; }
  </style>
</head>
<body>
  <div class="main-container">
    <h1>Perfil Territorial - {{ nombre_parroquia }}</h1>
    <nav class="navigation">{% for item in navegacion %}<a href="{{ item.href }}" class="{% if item.activo %}active{% endif %}"> {{ item.texto }}</a>{% endfor %}</nav>
    <div class="kpi-section">
      <div class="kpi-card">
        <div class="kpi-value" id="total-viviendas">-</div>
        <div class="kpi-label">Total de Viviendas</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" id="total-comunidades">-</div>
        <div class="kpi-label">Comunidades Representadas</div>
      </div>
    </div>

    <div class="chart-container">
      <div id="map"></div>
    </div>

    <footer>
      <span>powered by:</span>
      <img src="{{ url_for('static', filename='img/logo_geotactics.png') }}" alt="Geotactics">
    </footer>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    const nombreParroquia = "{{ nombre_parroquia }}";

    async function fetchData() {
      try {
        const response = await fetch(`/api/territorio/${nombreParroquia.replace(/ /g, '_')}`);
        const data = await response.json();
        renderMap(data.viviendas);
        updateKPIs(data.viviendas);
      } catch (error) {
        console.error("Error al obtener datos del territorio:", error);
      }
    }

    function updateKPIs(viviendas) {
      const total = viviendas.length;
      const comunidades = new Set(viviendas.map(v => v.comunidad));
      document.getElementById('total-viviendas').textContent = total;
      document.getElementById('total-comunidades').textContent = comunidades.size;
    }

    function renderMap(viviendas) {
      const map = L.map('map').setView([-0.5, -76.9], 9);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap',
        maxZoom: 18
      }).addTo(map);

      const clusterGroup = L.markerClusterGroup();

      const colors = {};
      let colorIndex = 0;
      const palette = ['#4CAF50', '#FF9800', '#03A9F4', '#E91E63', '#9C27B0', '#FFC107', '#00BCD4'];

      viviendas.forEach(v => {
        if (!v.lat || !v.lng) return;

        const color = colors[v.comunidad] || (colors[v.comunidad] = palette[colorIndex++ % palette.length]);

        const marker = L.circleMarker([v.lat, v.lng], {
          radius: 6,
          fillColor: color,
          color: '#ccc',
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
        });

        marker.bindPopup(`<b>Comunidad:</b> ${v.comunidad}<br><b>Barrio:</b> ${v.barrio || 'N/A'}`);
        clusterGroup.addLayer(marker);
      });

      map.addLayer(clusterGroup);
    }

    document.addEventListener('DOMContentLoaded', fetchData);
  </script>
</body>
</html>