<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil territorio: {{ nombre_parroquia }}</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Ubuntu', sans-serif; background-color: #0d1117; color: #c9d1d9; margin: 2em; }
        .main-container { width: 95%; max-width: 1800px; margin: 0 auto; }
        h1 { color: #58a6ff; text-align: center; font-weight: 300; margin-bottom: 20px; }
        h3 { font-weight: 400; color: #8b949e; margin: 0; text-align: left; margin-bottom: 15px; }
        .navigation { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; flex-wrap: wrap; }
        .navigation a { color: #8b949e; text-decoration: none; padding: 8px 15px; border-radius: 6px; border: 1px solid #30363d; }
        .navigation a.active, .navigation a:hover { color: #c9d1d9; background-color: #161b22; border-color: #58a6ff; }
        .page-layout { display: grid; grid-template-columns: 1fr 3.5fr; gap: 30px; align-items: start; }
        .left-column { display: flex; flex-direction: column; gap: 30px; position: sticky; top: 2em; }
        .sidebar-section { background-color: #161b22; border-radius: 8px; padding: 20px; border: 1px solid #30363d; }
        .filtro-desplegable { width: 100%; padding: 10px; background-color: #0d1117; color: #c9d1d9; border: 1px solid #30363d; border-radius: 6px; }
        .kpi-card { text-align: center; margin-bottom: 15px; }
        .kpi-value { font-size: 2.5em; font-weight: 700; color: #c9d1d9; transition: all 0.3s ease-in-out; }
        .kpi-label { font-size: 1em; color: #8b949e; text-align: center; }
        .narrativa-list { list-style: none; padding: 0; margin: 0; }
        .narrativa-list li { background-color: #0d1117; border-left: 2px solid #58a6ff; padding: 10px; margin-bottom: 8px; border-radius: 4px; font-size: 0.9em; }
        .chart-container { background-color: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; }
        #map { width: 100%; height: 100%; border-radius: 8px; }
        footer { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 50px; padding-top: 20px; border-top: 1px solid #30363d; }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>Perfil territorio: {{ nombre_parroquia }}</h1>
        <nav class="navigation">
            {% for item in navegacion %}
                <a href="{{ item.href }}" class="{% if item.activo %}active{% endif %}">{{ item.texto }}</a>
            {% endfor %}
        </nav>
        <div class="page-layout">
            <div class="left-column">
                <div class="sidebar-section">
                    <h3>Filtros</h3>
                    <label for="comunidad-filtro" class="kpi-label" style="text-align: left;">Filtrar por Comunidad</label>
                    <select id="comunidad-filtro" class="filtro-desplegable"><option value="Todas">-- Todas --</option></select>
                </div>
                <div class="sidebar-section" id="kpiContainer"></div>
                <div class="sidebar-section">
                    <h3>Comunidades en Vista</h3>
                    <ul class="narrativa-list" id="lista_comunidades"></ul>
                </div>
                <div class="sidebar-section">
                    <h3>Leyenda</h3>
                    <div id="legend"></div>
                </div>
            </div>
            <div class="main-content">
                <div class="chart-container" style="height: 80vh;">
                    <div id="map"></div>
                </div>
            </div>
        </div>
        <footer>
            <span>powered by:</span>
            <img src="{{ url_for('static', filename='img/logo_geotactics.png') }}" alt="Logo de Geotactics">
        </footer>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        const nombreParroquia = "{{ nombre_parroquia }}";
        let allViviendas = [], currentlyDisplayedData = [], map, clusterGroup;

        function updateDashboard(viviendasEnVista) {
            const kpiContainer = document.getElementById('kpiContainer');
            const listaComunidades = document.getElementById('lista_comunidades');
            if (!kpiContainer || !listaComunidades) return;
            const totalVisible = viviendasEnVista.length;
            const comunidadesVisibles = [...new Set(viviendasEnVista.map(v => v.comunidad))];
            kpiContainer.innerHTML = `<h3>Indicadores Dinámicos</h3><div class="kpi-card"><div class="kpi-value">${totalVisible.toLocaleString()}</div><div class="kpi-label">Viviendas en Vista</div></div><div class="kpi-card"><div class="kpi-value">${comunidadesVisibles.length}</div><div class="kpi-label">Comunidades en Vista</div></div>`;
            const conteoComunidades = viviendasEnVista.reduce((acc, v) => { acc[v.comunidad] = (acc[v.comunidad] || 0) + 1; return acc; }, {});
            if (comunidadesVisibles.length > 0) {
                listaComunidades.innerHTML = Object.entries(conteoComunidades).sort((a, b) => b[1] - a[1]).map(([nombre, count]) => `<li><b>${nombre}:</b> ${count} viv.</li>`).join('');
            } else {
                listaComunidades.innerHTML = '<li>No hay comunidades en la vista actual.</li>';
            }
        }

        function displayFilteredMarkers() {
            if (!clusterGroup) return;
            clusterGroup.clearLayers();
            const selectedComunidad = document.getElementById('comunidad-filtro').value;
            const viviendasFiltradas = selectedComunidad === 'Todas' ? allViviendas : allViviendas.filter(v => v.comunidad === selectedComunidad);
            currentlyDisplayedData = viviendasFiltradas;
            const colors = {}; let colorIndex = 0;
            const palette = ['#4CAF50', '#FF9800', '#03A9F4', '#E91E63', '#9C27B0', '#FFC107', '#00BCD4', '#8BC34A', '#FF5722', '#009688'];
            viviendasFiltradas.forEach(v => {
                if (!v.lat || !v.lng || isNaN(v.lat) || isNaN(v.lng)) return;
                const color = colors[v.comunidad] || (colors[v.comunidad] = palette[colorIndex++ % palette.length]);
                const marker = L.circleMarker([v.lat, v.lng], { radius: 6, fillColor: color, color: '#ccc', weight: 1, opacity: 1, fillOpacity: 0.8 });
                marker.bindPopup(`<b>Comunidad:</b> ${v.comunidad || 'Sin datos'}<br><b>Barrio:</b> ${v.barrio || 'Sin datos'}`);
                clusterGroup.addLayer(marker);
            });
            if (viviendasFiltradas.length > 1) {
                const bounds = L.featureGroup(clusterGroup.getLayers()).getBounds();
                if (bounds.isValid()) map.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
            } else if (viviendasFiltradas.length === 1) {
                map.setView([viviendasFiltradas[0].lat, viviendasFiltradas[0].lng], 14);
            } else {
                map.setView([-0.5, -76.9], 9);
            }
            const legend = document.getElementById('legend');
            if (legend) {
                legend.innerHTML = Object.entries(colors).sort((a,b) => a[0].localeCompare(b[0])).map(([comunidad, color]) => `
                    <div style="margin-bottom: 4px;"><span style="display:inline-block;width:12px;height:12px;background:${color};border-radius:50%;margin-right:8px;vertical-align:middle;"></span>${comunidad}</div>
                `).join('');
            }
            refreshDynamicData();
        }

        function refreshDynamicData() {
            if (!map) return;
            const bounds = map.getBounds();
            const viviendasVisibles = currentlyDisplayedData.filter(v => {
                if (v.lat && v.lng) { return bounds.contains(L.latLng(v.lat, v.lng)); }
                return false;
            });
            updateDashboard(viviendasVisibles);
        }
        
        function populateCommunityFilter(viviendas) {
            const selector = document.getElementById('comunidad-filtro');
            selector.innerHTML = '<option value="Todas">-- Todas las Comunidades --</option>';
            const comunidades = [...new Set(viviendas.map(v => v.comunidad).filter(Boolean))].sort();
            comunidades.forEach(c => { selector.add(new Option(c, c)); });
        }
    
        async function initializeMap() {
            map = L.map('map').setView([-0.5, -76.9], 9);
            clusterGroup = L.markerClusterGroup();
            map.addLayer(clusterGroup);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap', maxZoom: 18 }).addTo(map);
            try {
                const response = await fetch(`/api/territorio/{{ nombre_parroquia.replace(' ', '_') }}`);
                if (!response.ok) throw new Error(`Error HTTP ${response.status}`);
                const data = await response.json();
                allViviendas = data.viviendas || [];
                populateCommunityFilter(allViviendas);
                displayFilteredMarkers();
                map.on('moveend', refreshDynamicData);
                document.getElementById('comunidad-filtro').addEventListener('change', displayFilteredMarkers);
            } catch (error) {
                console.error("Error al obtener datos del territorio:", error);
                document.getElementById('kpiContainer').innerHTML = "<h3>Error al cargar datos</h3><p>No se pudo conectar con el servidor.</p>";
            }
        }
    
        document.addEventListener('DOMContentLoaded', initializeMap);
    </script>
</body>
</html>